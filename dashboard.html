<!doctype html>
<html lang=en>
  <head>
    <meta charset=UTF-8> 
    <meta name=viewport content="width=device-width,initial-scale=1">
    <meta name="description" content="Nabogaming - Ulimwengu bora wa online games, kushinda zawadi, na kufurahia burudani ya michezo mtandaoni. Jiunge nasi leo!">
    <meta name="keywords" content="Nabogaming, Michezo, Games Mtandaoni, Zawadi, Michezo ya ushindani, Ushindi, Michezo ya Mtandaoni">
    <meta name="author" content="Nabogaming">
    <meta property="og:title" content="Nabogaming">
    <meta property="og:description" content="Nabogaming furaha ya kushindana michezo ya online na kushinda zawadi kubwa kwenye Nabogaming. Usikose nafasi yako ya ushindi!">
    <meta property="og:image" content="https://nabogaming.com/1.png">
    <meta property="og:url" content="https://nabogaming.com">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Nabogaming">
    <meta name="twitter:description" content="Jiunge na Nabogaming kwa uzoefu bora wa kushindana michezo mtandaoni. Furahia ushindi leo!">
    <meta name="twitter:image" content="https://nabogaming.com/logo.png">
    <link rel="canonical" href="https://nabogaming.com">
    <link rel="icon" href="logo.png" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="logo.png" sizes="192x192">
  <link rel="icon" href="logo.png" sizes="512x512">
  
  <title>Nabogaming 2.5</title>
    <link rel=stylesheet href=app.css>
    <link rel=stylesheet href=2.css>
    <link rel=stylesheet href=remixicon.min.css>
<script type="module"> 
    function refreshData() {
  if (currentUser) {
    loadPosts();
    loadLikedPosts();
    loadUserAndTeams();
  }
}
setInterval(refreshData, 30000);

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
  import { getDatabase, ref, push, update, set, onValue, remove, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";
  import { updateProfile } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC_VKdV-KsIzUiOb7jFLsYXdTsuGkLiS-Q",
    authDomain: "register-71bde.firebaseapp.com",
    projectId: "register-71bde",
    storageBucket: "register-71bde.appspot.com",
    messagingSenderId: "412548441298",
    appId: "1:412548441298:web:e0fb2b6c5fbd4af7d0b90b",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase(app);
  const storage = getStorage(app);

let currentUser = null;
const premiumUsers = ["Sw9hx2GrwMYPkmzimgOMsTEbKK53"];

onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (currentUser) {
        loadPosts();
        loadLikedPosts();
        displayUserDetails();
        loadMessages();
        loadUserAndTeams();

        const isPremiumUser = premiumUsers.includes(currentUser?.uid);

        if (isPremiumUser) {
            await enablePremiumFeatures();
        } else {
            await enableFreeUserFeatures();
        }
    } else {
        showToast("You are not signed in. Redirecting to login...", "error");
        window.location.href = "index.html";
    }
});
const enablePremiumFeatures = async () => {
    showToast("Welcome Premium User! Enjoy exclusive features.", "success");
    const premiumButton = document.getElementById("premium-post-btn");
    if (premiumButton) {
        premiumButton.classList.remove("hidden");
    }
    const premiumOnlyElement = document.getElementById("premium-only-element");
    if (premiumOnlyElement) {
        premiumOnlyElement.style.display = 'block';
    }
};
const enableFreeUserFeatures = async () => {
    showToast("New Version 3.0 Coming 14th February...Get Ready", "info");
    const freeUserAdsElement = document.getElementById("free-user-ads");
    if (freeUserAdsElement) {
        freeUserAdsElement.style.display = 'block';
    }
    const premiumButton = document.getElementById("premium-post-btn");
    if (premiumButton) {
        premiumButton.classList.add("hidden");
    }
    const currentUserPremiumMessage = document.getElementById("current-user-premium");
    if (currentUserPremiumMessage) {
        currentUserPremiumMessage.style.display = 'block';
    }
};
document.addEventListener('DOMContentLoaded', () => {
  if (currentUser) {
    const userTeamsRef = ref(db, `teams/${currentUser.uid}`);
    get(userTeamsRef).then(snapshot => {
      if (snapshot.exists()) {
        const teamNumber = snapshot.val().team;
        const selectedBox = document.querySelector(`[data-team="${teamNumber}"]`);
        if (selectedBox) {
          const userPhoto = currentUser.photoURL || "default-profile-pic.jpg";
          const userName = currentUser.displayName || "Anonymous";
          selectedBox.querySelector('.plus-box').innerHTML = `<img src="${userPhoto}" alt="${userName}" style="width: 60px; height: 60px; border-radius: 50%;">`;
          selectedBox.querySelector('h5').textContent = userName;
        }
      }
    }).catch(error => {
      console.error("Error loading user team:", error);
    });

    const allTeamsRef = ref(db, `teams`);
    get(allTeamsRef).then(snapshot => {
      if (snapshot.exists()) {
        const teamsData = snapshot.val();
        Object.keys(teamsData).forEach(teamNumber => {
          const members = teamsData[teamNumber].members;
          const teamBox = document.querySelector(`[data-team="${teamNumber}"]`);
          if (teamBox) {
            const firstMember = Object.values(members)[0];
            if (firstMember) {
              teamBox.querySelector('.plus-box').innerHTML = `<img src="${firstMember.photo}" alt="${firstMember.name}" style="width: 60px; height: 60px; border-radius: 50%;">`;
              teamBox.querySelector('h5').textContent = firstMember.name;
            }
          }
        });
      }
    }).catch(error => {
      console.error("Error loading team members:", error);
    });
  }
});

document.querySelectorAll('.grid-modali-item').forEach(item => {
  item.addEventListener('click', () => handleBoxClick(item));
});

const handleBoxClick = (box) => {
  const teamNumber = box.dataset.team;

  if (!currentUser) {
    showToast('Please wait a moment...', 'info');
    return;
  }

  const userName = currentUser.displayName || "Anonymous";
  const userPhoto = currentUser.photoURL || "default-profile-pic.jpg";


  const userTeamsRef = ref(db, `teams/${currentUser.uid}`);
  get(userTeamsRef).then(snapshot => {
    if (snapshot.exists()) {
      const existingTeam = snapshot.val().team;
      showToast(`You are already a player ${existingTeam}. You cannot join another number.`, 'warning');
    } else {
      const teamMembersRef = ref(db, `teams/${teamNumber}/members`);
      get(teamMembersRef).then(snapshot => {
        if (snapshot.exists() && Object.keys(snapshot.val()).length > 0) {
          showToast(`Player ${teamNumber} is already taken.`, 'warning');
        } else {
          const teamRef = ref(db, `teams/${teamNumber}/members/${currentUser.uid}`);

set(teamRef, {
  name: userName,
  photo: userPhoto
}).then(() => {
  showToast(`Welcome player ${teamNumber}!`, 'success');

box.querySelector('.plus-box').innerHTML = `
  <img src="${userPhoto}" alt="${userName}" style="width: 60px; height: 60px; border-radius: 50%;">
  <div class="player-number" style="position: absolute; bottom: 5px; right: 5px;z-index:99999; background: #3aafa9; color: white; padding: 2px 5px; border-radius: 3px; font-size: 12px;">
    #${teamNumber}
  </div>`;
 
  box.querySelector('h5').textContent = userName;
  updateUserTeam(currentUser.uid, teamNumber);
}).catch(error => {
  console.error("Error joining team:", error);
  showToast("Failed to join as a player. Please try again.", 'error');
 });
        }
      }).catch(error => {
        console.error("Error checking team box:", error);
      });
    }
  }).catch(error => {
    console.error("Error checking user team:", error);
  });
};


function loadUserAndTeams() {
  const userTeamsRef = ref(db, `teams/${currentUser.uid}`);
  get(userTeamsRef).then(snapshot => {
    if (snapshot.exists()) {
      const teamNumber = snapshot.val().team;
      const selectedBox = document.querySelector(`[data-team="${teamNumber}"]`);
      if (selectedBox) {
        const userPhoto = currentUser.photoURL || "default-profile-pic.jpg";
        const userName = currentUser.displayName || "Anonymous";
        selectedBox.querySelector('.plus-box').innerHTML = `
          <img src="${userPhoto}" alt="${userName}" style="width: 60px; height: 60px; border-radius: 50%;">
          <div class="player-number" style="position: absolute; bottom: 5px; right: 5px; z-index: 99999; background: #3aafa9; color: white; padding: 2px 5px; border-radius: 3px; font-size: 12px;">
            #${teamNumber}
          </div>`;
        selectedBox.querySelector('h5').textContent = userName;
      }
    }
  }).catch(error => {
    console.error("Error loading user team:", error);
  });

  const allTeamsRef = ref(db, `teams`);
  get(allTeamsRef).then(snapshot => {
    if (snapshot.exists()) {
      const teamsData = snapshot.val();
      Object.keys(teamsData).forEach(teamNumber => {
        const members = teamsData[teamNumber]?.members;
        const teamBox = document.querySelector(`[data-team="${teamNumber}"]`);
        if (teamBox && members) {
          const firstMember = Object.values(members)[0];
          if (firstMember) {
            teamBox.querySelector('.plus-box').innerHTML = `
              <img src="${firstMember.photo}" alt="${firstMember.name}" style="width: 60px; height: 60px; border-radius: 50%;">
              <div class="player-number" style="position: absolute; bottom: 5px; right: 5px; z-index: 99999; background: #3aafa9; color: white; padding: 2px 5px; border-radius: 3px; font-size: 12px;">
                #${teamNumber}
              </div>`;
            teamBox.querySelector('h5').textContent = firstMember.name;
          }
        }
      });
    }
  }).catch(error => {
    console.error("Error loading team members:", error);
  });
}



const updateUserTeam = (userId, teamNumber) => {
  const userTeamsRef = ref(db, `teams/${userId}`);
  set(userTeamsRef, {
    team: teamNumber
  });
};


  const showToast = (message, type = 'info') => {
    const toast = document.createElement('div');
    toast.classList.add('toast', type);
    toast.textContent = message;

    document.body.appendChild(toast);
    setTimeout(() => {
      toast.remove();
    }, 3000);
  };

  const style = document.createElement('style');
  style.textContent = `
.toast {
    position: fixed;
    top: 0;
    left: 50%;
    padding: 13px; /* Padding for spacing */
    transform: translateX(-50%);
    width: 100vw; /* Full width of the viewport */
    height: 60px;
    color: white;
    display: flex; /* Use flexbox for centering */
    align-items: center; /* Center vertically */
    justify-content: center; /* Center horizontally */
    text-align: center;
    font-size: 14px;
    opacity: 0;
    z-index: 999999;
    animation: slideFromTop 0.5s ease-out forwards;
    border-left: 3px solid;
}

.toast.success {
    border-left-color: green;
    border-left-width: 7px; /* Adjust the width as needed */
    border-left-style: solid; /* Ensure the border is visible */
    background-color: white;
    color: green;
}


.toast.error {
    border-left-color: #f44336;
    background-color: white;
     border-left-width: 7px; /* Adjust the width as needed */
    border-left-style: solid; /* Ensure the border is visible */
    color: #f44336;
}

.toast.info {
    border-left-color: blue;
     border-left-width: 7px; /* Adjust the width as needed */
    border-left-style: solid; /* Ensure the border is visible */
    background-color: white;
    color: blue;
}

.toast.warning {
    border-left-color: #FF9800;
     border-left-width: 7px; /* Adjust the width as needed */
    border-left-style: solid; /* Ensure the border is visible */
    background-color: white;
    color: #FF9800;
}

/* Slide from top animation */
@keyframes slideFromTop {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

  `;
  document.head.appendChild(style);

  const formatTimestamp = (timestamp) => {
    const now = new Date();
    const timeDiff = now - new Date(timestamp);
    const seconds = Math.floor(timeDiff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    const months = Math.floor(days / 30);
    const years = Math.floor(months / 12);

    if (seconds < 60) return `Just now`;
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}hr ago`;
    if (days < 30) return `${days}d ago`;
    if (months < 12) return `${months}mo ago`;
    return `${years}yr `;
  };


const loadPosts = () => {
  const allPostsContainer = document.getElementById("allposts");
  const myPostsContainer = document.getElementById("myposts");

  if (!allPostsContainer || !myPostsContainer) return;

  allPostsContainer.innerHTML = "";
  myPostsContainer.innerHTML = "";

  const postsRef = ref(db, "posts");
  onValue(postsRef, (snapshot) => {
    const posts = [];
    snapshot.forEach((childSnapshot) => {
      const post = childSnapshot.val();
      const postId = childSnapshot.key;
      posts.push({ postId, ...post });
    });


    posts.sort((a, b) => b.timestamp - a.timestamp);


    const myPosts = posts.filter(post => post.authorName === currentUser.displayName);
    const allPosts = posts;


    myPosts.forEach(post => displayPost(post, myPostsContainer, true));

    allPosts.forEach(post => displayPost(post, allPostsContainer, false));


    insertRandomContent();
  });
};


function insertRandomContent() {
  const allPostsContainer = document.getElementById("allposts");
  const randomContent = document.getElementById("myRandomContent"); // External content

  if (allPostsContainer && randomContent) {
    // Clone the random content to make it reusable
    const contentClone = randomContent.cloneNode(true);
    contentClone.style.display = "block"; // Make sure it's visible

    // Get all child elements of the posts container
    const allPostsChildren = Array.from(allPostsContainer.children);

    // Calculate the middle index
    const middleIndex = Math.floor(allPostsChildren.length / 2);

    // Insert the cloned content at the middle index
    if (allPostsChildren.length > 0) {
      allPostsContainer.insertBefore(contentClone, allPostsChildren[middleIndex]);
    } else {
      allPostsContainer.appendChild(contentClone);
    }
  }
}



  const loadLikedPosts = () => {
    const likedPostsContainer = document.getElementById("likedposts");
    if (!likedPostsContainer) return;

    likedPostsContainer.innerHTML = "";

    const postsRef = ref(db, "posts");
    onValue(postsRef, (snapshot) => {
      const posts = [];
      snapshot.forEach((childSnapshot) => {
        const post = childSnapshot.val();
        const postId = childSnapshot.key;
        posts.push({ postId, ...post });
      });

      posts.sort((a, b) => b.timestamp - a.timestamp);

      // Filter liked posts (exclude posts by the current user)
      const likedPosts = posts.filter(post => post.likes && post.likes[currentUser.uid] && post.authorName !== currentUser.displayName);
      likedPosts.forEach(post => displayPost(post, likedPostsContainer, false));  // No delete button for liked posts
    });
  };

const displayPost = (post, container, isMyPost) => {
  const existingPost = container.querySelector(`[data-post-id="${post.postId}"]`);
  if (existingPost) return;

  const commentCount = post.comments ? Object.keys(post.comments).length : 0;

  const postElement = document.createElement("div");
  postElement.className = "instagram-post-2";
  postElement.setAttribute("data-post-id", post.postId);

  const shareUrl = `${window.location.origin}/dashboard.html?postId=${post.postId}`;

  postElement.innerHTML = `
    <div class="post-header">
      <div class="profile-picture">
        <img src="${post.authorPhoto}" alt="User profile picture">
      </div>
      <div class="profile-details">
        <div class="profile-name">${post.authorName}</div>
        <div class="post-time-2">${formatTimestamp(post.timestamp)} • <span class="like-count"> Public</span></div>
      </div>
        <div class="post-options">
                <i class="ri-more-fill"></i>
                <div class="options-menu">
                  <ul>
                  ${isMyPost ? `<li class="edit-btn" data-id="${post.postId}">Edit The Post</li>` : ""}
                  <li class="toggle-comments" data-id="${post.postId}">View Post</li>
                    ${isMyPost ? `<li class="delete-post-btn" data-id="${post.postId}">Delete My Post</li>` : ""}
                  </ul>
                </div>
              </div>
    </div>
    <div class="post-image">
      <img src="${post.imageUrl}" alt="Post content">
    </div>
           <div class="caption">
     <span class=username>${post.authorName}</span>
     ${post.content}
    </div>
<div class="post-actions">
  <div class="actions-left">
    <div class="action-item like-btn" data-id="${post.postId}">
      <i class="ri-heart-line"></i>
      <span class="count">${Object.keys(post.likes || {}).length}</span>
    </div> 
    <div class="action-item toggle-comments" data-id="${post.postId}">
      <i class="ri-message-2-line"></i>
      <span class="count">${commentCount}</span>
    </div>
  </div>
  <div class="actions-right">
    <div class="action-item share-btn" data-id="${post.postId}" data-url="${shareUrl}">
      <i class="ri-share-line"></i>
    </div>
  </div>
</div>
 
  `;

  container.appendChild(postElement);

  postElement.querySelector(".like-btn").addEventListener("click", () => likePost(post.postId));
  postElement.querySelector(".toggle-comments").addEventListener("click", () => showCommentsPopup(post));
  postElement.querySelector(".share-btn").addEventListener("click", () => {
    navigator.clipboard.writeText(shareUrl).then(() => {
      showToast("Link copied to clipboard!", "success");
    }).catch((err) => {
      console.error("Failed to copy link: ", err);
      showToast("Failed to copy link", "error");
    });
  });

  // Add event listener for opening the post in a new tab
  postElement.querySelector(".post-image img").addEventListener("click", () => {
    showToast("Please wait for the shared post...", "info"); // Toast message
    window.open(shareUrl, "_blank"); // Open the shared post in a new tab
  });

  if (isMyPost) {
    postElement.querySelector(".delete-post-btn").addEventListener("click", () => deletePost(post.postId));
    postElement.querySelector(".edit-btn").addEventListener("click", () => editPost(post));
  }
};


const urlParams = new URLSearchParams(window.location.search);
const postIdFromUrl = urlParams.get('postId');

if (postIdFromUrl) {
  const postsRef = ref(db, `posts/${postIdFromUrl}`);
  get(postsRef).then(snapshot => {
    if (snapshot.exists()) {
      const post = snapshot.val();
      post.postId = postIdFromUrl;
      showCommentsPopup(post);
    } else {
      showToast("Pole! Post Hiyo Inawezekana Imefutwa Au Haipo.", "error");
    }
  }).catch(error => {
    console.error("Error loading post: ", error);
    showToast("Error loading post.", "error");
  });
}


const showCommentsPopup = (post) => {
  const popup = document.createElement('div');
  popup.className = 'comments-popup';

  popup.innerHTML = 